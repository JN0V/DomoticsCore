# DomoticsCore v1.1.0 - Critical Bugs Summary

> **‚ö†Ô∏è ARCHIVED:** Bug reports could not be reproduced with v1.1.0 code.
> - Bug #1 (MQTT.h): Already fixed in v1.1.0 code
> - Bug #2 (Early-init crash): Not reproducible - tests pass successfully
> 
> Likely causes: Reports based on older code version or WaterMeter-specific issues.
> 
> See `tests/unit/03-bug2-early-init/` and `tests/unit/04-system-scenario/` for reproduction attempts.

---

**Project:** WaterMeter v0.6.0  
**Testing Date:** October 31, 2025  
**Status:** ~~2 CRITICAL bugs prevent full adoption of v1.1.0 features~~ NOT REPRODUCIBLE

---

## üêõ Bug #1: MQTT Component Not Updated (Compilation Error)

**Severity:** CRITICAL - Prevents compilation

**File:** `DomoticsCore-MQTT/include/DomoticsCore/MQTT.h:151`

**Current:**
```cpp
std::vector<String> getDependencies() const override { return {}; }
```

**Should Be:**
```cpp
std::vector<Dependency> getDependencies() const override { return {}; }
```

**Error:**
```
error: invalid covariant return type for 'virtual std::vector<String> 
DomoticsCore::Components::MQTTComponent::getDependencies() const'
```

**Workaround:** Manual edit of MQTT.h locally

**Fix Required:** Update MQTT.h to match IComponent.h signature

---

## üêõ Bug #2: Optional Dependencies + Early-Init = CRASH (Runtime Error)

**Severity:** CRITICAL - Device crashes on boot

**Scenario:**
```cpp
// Custom component declares optional dependencies
class WaterMeterComponent : public IComponent {
    std::vector<Dependency> getDependencies() const override {
        return {
            {"Storage", false},  // ‚ùå CRASHES!
            {"NTP", false}
        };
    }
};
```

**Crash Log:**
```
[STORAGE] Storage component initialized (early) ‚úì
[CORE] Component 'WaterMeter' optional dependency 'Storage' not available (OK)
Guru Meditation Error: Core 1 panic'ed (LoadProhibited)
EXCVADDR: 0x00000000
at ComponentRegistry.h:95 in initializeAll()
```

**Root Cause:**
1. Custom component added BEFORE `begin()` ‚Üí declares optional deps on Storage/NTP
2. `begin()` starts ‚Üí `resolveDependencies()` runs
3. Storage/NTP NOT YET in componentMap (registered later as "early init")
4. Dependencies marked "not available (OK)"
5. `initializeAll()` crashes trying to access null component pointer

**Timeline Issue:**
```
User: addComponent(WaterMeter)           // Declares {"Storage", false}
      begin()                            // Framework starts
        resolveDependencies()            // Storage not in map ‚Üí "not available"
        initEarlyComponents()            // NOW Storage is registered
        initializeAll()                  // Crash - component pointer null
```

**Workaround:**
```cpp
std::vector<Dependency> getDependencies() const override {
    return {};  // Don't declare built-ins
}

void afterAllComponentsReady() override {
    auto* storage = getCore()->getComponent<StorageComponent>("Storage");
    if (storage) {  // Defensive check still required
        loadFromStorage();
    }
}
```

**What Works:** `afterAllComponentsReady()` lifecycle callback ‚úÖ  
**What's Broken:** Optional dependencies on early-init built-ins ‚ùå

**Fix Options:**
1. **Option A:** Resolve dependencies AFTER early-init components registered
2. **Option B:** Allow dependencies on components not yet in registry
3. **Option C:** Document limitation (optional deps only work custom‚Üícustom)

---

## üìä Impact on WaterMeter Project

### Features Working ‚úÖ
- Lifecycle callback `afterAllComponentsReady()` - **GREAT feature!**
- Lazy Core injection (v1.0.2)
- Native uint64_t storage (v1.0.1)
- Clean GPIO/dependency separation

### Features Broken ‚ùå
- Optional dependency declaration
- Explicit intent for built-in component dependencies
- Framework logging of missing optional deps

### Current State
- **Version:** v0.6.0
- **Status:** Workaround applied, compiles and runs
- **Pattern:** Hybrid v1.0.2 (empty deps) + v1.1.0 (lifecycle callback)
- **Quality:** Better than v0.5.2 thanks to `afterAllComponentsReady()`

---

## üí° Recommendations

### Short Term (v1.1.1)
1. Fix MQTT.h signature (trivial, 1-line change)
2. Fix optional dependencies + early-init crash
3. Add integration test for this scenario

### Documentation (Urgent)
Until fixed, document:
- Optional dependencies only work for custom‚Üícustom components
- Built-in components (Storage, MQTT, NTP, WiFi) cannot be declared
- Use defensive null checks pattern
- `afterAllComponentsReady()` is safe for accessing built-ins

### Long Term
Consider architecture where:
- All components registered BEFORE any dependency resolution
- Or dependency resolution happens in two phases (custom‚Üícustom, then built-ins)

---

## üß™ Testing Evidence

**Full crash logs:** Available in WaterMeter project  
**Reproducible:** 100% - every boot with optional deps declared  
**Workaround tested:** ‚úÖ Works perfectly  
**Real hardware:** ESP32 DevKit v1  
**Framework:** Arduino ESP32

---

## üìù Files for Review

In `../DomoticsCore/Roadmap.md`:
- Bug #1 report
- Bug #2 detailed analysis with timeline

In WaterMeter project:
- Working code with workaround
- Complete CHANGELOG documenting both bugs
- Defensive patterns that work reliably

**Status:** Waiting for v1.1.1 with fixes

**Appreciation:** Thank you for quick v1.1.0 implementation! The `afterAllComponentsReady()` callback is excellent. These bugs are fixable and the overall direction is great! üéØ

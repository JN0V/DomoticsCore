# Migration Guide: v1.1.x ‚Üí v1.2.0

## Overview

Version 1.2.0 introduces **EventBus-only communication** for MQTT and HomeAssistant components, removing direct callback APIs and component dependencies. This improves modularity, testability, and eliminates tight coupling.

---

## üî¥ Breaking Changes

### 1. MQTT Component - Callbacks Removed

**What changed:**
- Direct callback methods (`onConnect`, `onDisconnect`, `onMessage`) have been removed
- All communication now flows through EventBus topics

**Migration path:**

#### Old Code (v1.0.x):
```cpp
auto mqtt = std::make_unique<MQTTComponent>(config);
auto* mqttPtr = mqtt.get();
core.addComponent(std::move(mqtt));

mqttPtr->onConnect([]() {
    mqttPtr->publish("status", "online");
    mqttPtr->subscribe("commands/#");
});

mqttPtr->onDisconnect([]() {
    // Handle disconnect
});

mqttPtr->onMessage("commands/#", [](String topic, String payload) {
    // Handle message
});
```

#### New Code (v1.2.0):

**Option A: Using `core.on<>()` and `core.emit()` (Minimal Examples)**
```cpp
core.addComponent(std::make_unique<MQTTComponent>(config));

// Listen to mqtt/connected
core.on<bool>("mqtt/connected", [&core](const bool&) {
    // Publish via EventBus
    MQTTPublishEvent pubEv{};
    strncpy(pubEv.topic, "status", sizeof(pubEv.topic) - 1);
    strncpy(pubEv.payload, "online", sizeof(pubEv.payload) - 1);
    pubEv.qos = 0;
    pubEv.retain = false;
    core.emit("mqtt/publish", pubEv);
    
    // Subscribe via EventBus
    MQTTSubscribeEvent subEv{};
    strncpy(subEv.topic, "commands/#", sizeof(subEv.topic) - 1);
    subEv.qos = 0;
    core.emit("mqtt/subscribe", subEv);
});

// Listen to mqtt/disconnected
core.on<bool>("mqtt/disconnected", [](const bool&) {
    // Handle disconnect
});

// Listen to mqtt/message
core.on<MQTTMessageEvent>("mqtt/message", [](const MQTTMessageEvent& ev) {
    String topic = String(ev.topic);
    String payloadStr = String(ev.payload);
    // Handle message
});
```

**Option B: Using `IComponent::on<>()` (Inside Components)**
```cpp
class MyComponent : public IComponent {
public:
    ComponentStatus begin() override {
        // Listen to MQTT events
        on<bool>("mqtt/connected", [this](const bool&) {
            // Publish via EventBus
            MQTTPublishEvent ev{};
            strncpy(ev.topic, "status", sizeof(ev.topic) - 1);
            strncpy(ev.payload, "online", sizeof(ev.payload) - 1);
            emit("mqtt/publish", ev);
        });
        
        on<MQTTMessageEvent>("mqtt/message", [this](const MQTTMessageEvent& ev) {
            // Handle incoming message
        });
        
        return ComponentStatus::Success;
    }
};
```

---

### 2. HomeAssistant Component - Constructor Changed

**What changed:**
- Constructor no longer takes `MQTTComponent*` parameter
- HomeAssistant communicates with MQTT via EventBus only

**Migration path:**

#### Old Code (v1.0.x):
```cpp
auto mqtt = std::make_unique<MQTTComponent>(mqttConfig);
auto* mqttPtr = mqtt.get();
core.addComponent(std::move(mqtt));

HAConfig haConfig;
haConfig.nodeId = "my-device";
auto ha = std::make_unique<HomeAssistantComponent>(mqttPtr, haConfig);
```

#### New Code (v1.1.0):
```cpp
core.addComponent(std::make_unique<MQTTComponent>(mqttConfig));

HAConfig haConfig;
haConfig.nodeId = "my-device";
auto ha = std::make_unique<HomeAssistantComponent>(haConfig);
// ‚úÖ No MQTT reference needed!
```

---

## üêõ Bug Fixes Included

### Critical Bug #1: EventBus Listener Registration
**Problem:** EventBus listeners were registered AFTER configuration checks, causing them to be skipped if no broker was configured initially.

**Impact:** Discovery and subscriptions would fail after configuring MQTT via WebUI (reboot required).

**Fixed:** Listeners now registered BEFORE configuration checks.

### Critical Bug #2: PubSubClient Callback Registration
**Problem:** `mqttClient.setCallback()` was called AFTER configuration checks, causing incoming MQTT messages to be silently dropped.

**Impact:** Switch commands from Home Assistant were not received.

**Fixed:** Callback now registered BEFORE configuration checks.

---

## üìö EventBus Topics Reference

### MQTT Component

**Emitted Events:**
- `mqtt/connected` (bool) - Fired when connected to broker
- `mqtt/disconnected` (bool) - Fired when disconnected
- `mqtt/message` (MQTTMessageEvent) - Fired for each incoming message

**Listened Events:**
- `mqtt/publish` (MQTTPublishEvent) - Publish a message to broker
- `mqtt/subscribe` (MQTTSubscribeEvent) - Subscribe to a topic

**Event Structures:**
```cpp
struct MQTTPublishEvent {
    char topic[128];
    char payload[512];
    uint8_t qos;
    bool retain;
};

struct MQTTSubscribeEvent {
    char topic[128];
    uint8_t qos;
};

struct MQTTMessageEvent {
    char topic[128];
    char payload[512];
};
```

### HomeAssistant Component

**Emitted Events:**
- Uses `mqtt/publish` and `mqtt/subscribe` (via MQTT component)

**Listened Events:**
- `mqtt/connected` - Triggers discovery publication
- `mqtt/disconnected` - Tracks MQTT state
- `mqtt/message` - Handles incoming commands

---

## üîç Testing Your Migration

### 1. Compilation Test
```bash
pio run -d your_project
```

### 2. Runtime Test
1. Upload firmware
2. Monitor serial output for EventBus registration logs
3. Configure MQTT via WebUI (if not pre-configured)
4. Verify discovery works WITHOUT reboot
5. Test switch commands from Home Assistant

### 3. Expected Logs
```
[MQTT] EventBus listeners registered (mqtt/publish, mqtt/subscribe)
[MQTT] PubSubClient callback registered
[HA] Publishing HA discovery after MQTT connect
[HA] Publishing state: relay = ON
```

---

## üí° Best Practices

### EventBus Usage

**DO:**
- ‚úÖ Use `core.getEventBus()` in standalone examples
- ‚úÖ Use `on<>()` and `emit()` inside components
- ‚úÖ Capture necessary data in lambda closures
- ‚úÖ Use typed events for compile-time safety

**DON'T:**
- ‚ùå Store raw pointers to other components
- ‚ùå Call component methods directly across boundaries
- ‚ùå Block in event handlers (keep them fast)
- ‚ùå Assume synchronous event delivery

### Component Communication

**Before (Tight Coupling):**
```cpp
class MyComponent : public IComponent {
    MQTTComponent* mqtt;  // ‚ùå Direct dependency
    
    void doSomething() {
        if (mqtt->isConnected()) {
            mqtt->publish("topic", "data");  // ‚ùå Direct call
        }
    }
};
```

**After (Loose Coupling):**
```cpp
class MyComponent : public IComponent {
    bool mqttConnected = false;  // ‚úÖ Track state via events
    
    ComponentStatus begin() override {
        on<bool>("mqtt/connected", [this](const bool&) {
            mqttConnected = true;  // ‚úÖ Update state
        });
        
        on<bool>("mqtt/disconnected", [this](const bool&) {
            mqttConnected = false;
        });
        
        return ComponentStatus::Success;
    }
    
    void doSomething() {
        if (mqttConnected) {
            MQTTPublishEvent ev{};
            strncpy(ev.topic, "topic", sizeof(ev.topic) - 1);
            strncpy(ev.payload, "data", sizeof(ev.payload) - 1);
            emit("mqtt/publish", ev);  // ‚úÖ Emit event
        }
    }
};
```

---

## üìñ Additional Resources

- **EventBus Architecture**: See `docs/EVENTBUS_ARCHITECTURE.md`
- **Examples**: Check updated examples in each component folder
- **API Reference**: Generated Doxygen docs in `docs/html/`

---

## üÜò Troubleshooting

### Issue: "MQTT messages not received"
**Solution:** Ensure `mqttClient.setCallback()` fix is applied (automatic in v1.1.0)

### Issue: "Discovery doesn't work after WebUI config"
**Solution:** Ensure EventBus listeners are registered before `core.begin()` call

### Issue: "Compilation error with onConnect/onMessage"
**Solution:** These methods were removed in v1.2.0 - migrate to EventBus (see above)

### Issue: "HomeAssistant constructor expects 1 arg, got 2"
**Solution:** Remove MQTTComponent* parameter from constructor

---

## üìù Version History

- **v1.0.x**: Direct callbacks, component dependencies
- **v1.1.x**: Unified metadata, improved architecture
- **v1.2.0**: EventBus-only, `core.on<>()`/`core.emit()` API, critical bug fixes

For questions or issues, please open a GitHub issue with the `migration` label.
